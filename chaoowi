BƯỚC 1 — VÀO CONTAINER CLI

Chạy:

docker exec -it cli bash

✅ BƯỚC 2 — JOIN PEER CỦA BANK A vào channel
Thiết lập environment cho Bank A — peer0.banka.example.com
export CORE_PEER_LOCALMSPID="bankaMSP"
export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/users/Admin@banka.example.com/msp
export CORE_PEER_ADDRESS=peer0.banka.example.com:7051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/peers/peer0.banka.example.com/tls/ca.crt

export CHANNEL_NAME=bankchannel

Join peer0.banka:
peer channel join -b ./channel-artifacts/bankchannel.block


✅ Nếu thành công bạn sẽ thấy:
Successfully submitted proposal to join channel

✅ BƯỚC 3 — JOIN peer1 của BANK A

Thiết lập:

export CORE_PEER_ADDRESS=peer1.banka.example.com:8051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/peers/peer1.banka.example.com/tls/ca.crt


Join:

peer channel join -b ./channel-artifacts/bankchannel.block

✅ BƯỚC 4 — JOIN các peer của BANK B
peer0.bankb
export CORE_PEER_LOCALMSPID="bankbMSP"
export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/users/Admin@bankb.example.com/msp
export CORE_PEER_ADDRESS=peer0.bankb.example.com:9051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/peers/peer0.bankb.example.com/tls/ca.crt


Join:

peer channel join -b ./channel-artifacts/bankchannel.block

peer1.bankb
export CORE_PEER_ADDRESS=peer1.bankb.example.com:11051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/peers/peer1.bankb.example.com/tls/ca.crt


Join:

peer channel join -b ./channel-artifacts/bankchannel.block

✅ BƯỚC 5 — UPDATE ANCHOR PEER

Mỗi tổ chức cần 1 anchor peer.

✅ Anchor Peer Bank A
export CORE_PEER_LOCALMSPID="bankaMSP"
export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/users/Admin@banka.example.com/msp
export CORE_PEER_ADDRESS=peer0.banka.example.com:7051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/peers/peer0.banka.example.com/tls/ca.crt


Tạo update tx:

configtxgen -profile BankchainChannel \
  -outputAnchorPeersUpdate ./channel-artifacts/bankaMSPanchors.tx \
  -channelID $CHANNEL_NAME \
  -asOrg BankA


Update:

peer channel update -o orderer.example.com:7050 \
  --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt \
  -f ./channel-artifacts/bankaMSPanchors.tx \
  -c $CHANNEL_NAME

✅ Anchor Peer Bank B
export CORE_PEER_LOCALMSPID="bankbMSP"
export CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/users/Admin@bankb.example.com/msp
export CORE_PEER_ADDRESS=peer0.bankb.example.com:9051
export CORE_PEER_TLS_ROOTCERT_FILE=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/peers/peer0.bankb.example.com/tls/ca.crt


Tạo update:

configtxgen -profile BankchainChannel \
  -outputAnchorPeersUpdate ./channel-artifacts/bankbMSPanchors.tx \
  -channelID $CHANNEL_NAME \
  -asOrg BankB


Update:

peer channel update -o orderer.example.com:7050 \
  --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt \
  -f ./channel-artifacts/bankbMSPanchors.tx \
  -c $CHANNEL_NAME

✅ BƯỚC 6 — DEPLOY CHAINCODE (smart contract)

Ví dụ chaincode trong thư mục:

../chaincode/bankcc

1. Package chaincode

Set peer về BankA:

export CORE_PEER_LOCALMSPID="bankaMSP"
export CORE_PEER_ADDRESS=peer0.banka.example.com:7051

peer lifecycle chaincode package bankcc.tar.gz \
  --path /opt/gopath/src/github.com/chaincode/bankcc \
  --lang golang \
  --label bankcc_1

2. Install chaincode lên tất cả peer

BankA peer0:

peer lifecycle chaincode install bankcc.tar.gz


BankA peer1:

export CORE_PEER_ADDRESS=peer1.banka.example.com:8051
peer lifecycle chaincode install bankcc.tar.gz


BankB peer0:

export CORE_PEER_LOCALMSPID="bankbMSP"
export CORE_PEER_ADDRESS=peer0.bankb.example.com:9051
peer lifecycle chaincode install bankcc.tar.gz


BankB peer1:

export CORE_PEER_ADDRESS=peer1.bankb.example.com:11051
peer lifecycle chaincode install bankcc.tar.gz

3. Query package ID
peer lifecycle chaincode queryinstalled


Copy dòng kiểu:

Package ID: bankcc_1:23ab1b5d9...

4. Approve chaincode

Ví dụ packageID là:

bankcc_1:23ab1b5d9abc123456


Bank A approve:

export CORE_PEER_LOCALMSPID="bankaMSP"
export CORE_PEER_ADDRESS=peer0.banka.example.com:7051

peer lifecycle chaincode approveformyorg \
  -o orderer.example.com:7050 \
  --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt \
  --channelID $CHANNEL_NAME \
  --name bankcc \
  --version 1.0 \
  --package-id bankcc_1:23ab1b5d9abc123456 \
  --sequence 1


Bank B cũng approve.

5. Commit chaincode

Set peer BankA:

export CORE_PEER_LOCALMSPID="bankaMSP"
export CORE_PEER_ADDRESS=peer0.banka.example.com:7051

peer lifecycle chaincode commit \
  -o orderer.example.com:7050 \
  --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt \
  --channelID $CHANNEL_NAME \
  --name bankcc \
  --version 1.0 \
  --sequence 1 \
  --peerAddresses peer0.banka.example.com:7051 \
  --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/peers/peer0.banka.example.com/tls/ca.crt \
  --peerAddresses peer0.bankb.example.com:9051 \
  --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/bankb.example.com/peers/peer0.bankb.example.com/tls/ca.crt

✅ BƯỚC 7 — INVOKE CHAINCODE

Ví dụ gọi hàm:

peer chaincode invoke \
  -o orderer.example.com:7050 \
  --tls --cafile /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ordererOrganizations/example.com/orderers/orderer.example.com/tls/ca.crt \
  -C $CHANNEL_NAME \
  -n bankcc \
  --peerAddresses peer0.banka.example.com:7051 \
  --tlsRootCertFiles /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/banka.example.com/peers/peer0.banka.example.com/tls/ca.crt \
  -c '{"Args":["InitLedger"]}'

✅ BƯỚC 8 — QUERY
peer chaincode query \
  -C $CHANNEL_NAME \
  -n bankcc \
  -c '{"Args":["QueryAll"]}'
