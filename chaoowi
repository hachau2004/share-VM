‚úÖ B∆∞·ªõc ti·∫øp theo (B∆∞·ªõc 5 ‚Äì 6 trong t√†i li·ªáu)

Gi·ªù b·∫°n ƒë√£ c√≥ b·ªô key trong:

usdx-keys.json


B·∫°n c·∫ßn:

B∆Ø·ªöC 5 ‚Äî L∆∞u asset issuer v√†o ENV ƒë·ªÉ c·∫£ h·ªá th·ªëng d√πng

T·∫°o file .env (n·∫øu ch∆∞a c√≥):

touch .env


Th√™m v√†o:

ISSUER_PUBLIC=<copy t·ª´ usdx-keys.json>
ISSUER_SECRET=<copy t·ª´ usdx-keys.json>
BANKA_PUBLIC=<copy>
BANKA_SECRET=<copy>
BANKB_PUBLIC=<copy>
BANKB_SECRET=<copy>

HORIZON=http://localhost:8000
NETWORK_PASSPHRASE="Standalone Network ; February 2017"

B∆Ø·ªöC 6 ‚Äî Ki·ªÉm tra t√†i s·∫£n USDX tr√™n m·∫°ng
1Ô∏è‚É£ Ki·ªÉm tra BankA ƒë√£ c√≥ 10,000 USDX ch∆∞a

Ch·∫°y:

node


R·ªìi trong Node REPL nh·∫≠p:

const StellarSDK = require("stellar-sdk");
const server = new StellarSDK.Server("http://localhost:8000", { allowHttp: true });

let acc = await server.loadAccount("<BANKA_PUBLIC>");
console.log(acc.balances);


üëâ B·∫°n s·∫Ω th·∫•y:

[
  { asset_type: 'native', balance: '9999.9999800' },
  { asset_type: 'credit_alphanum4', asset_code: 'USDX', balance: '10000.0000000' }
]

B∆Ø·ªöC 7 ‚Äî T·∫°o API ƒë·ªÉ BANKA/BANKB giao d·ªãch USDX

N·∫øu b·∫°n mu·ªën:

‚úî Web backend
‚úî API transfer
‚úî API issue USDX
‚úî API check balance
‚úî API verify trustline

M√¨nh c√≥ th·ªÉ vi·∫øt full Node.js Express server cho b·∫°n (ch·ªâ c·∫ßn b·∫£o m√¨nh).

node scripts/create_usdx_network.js


Script s·∫Ω t·∫°o 3 keypairs, g·ªçi friendbot (http://localhost:8000/friendbot
) ƒë·ªÉ fund, set trustlines BankA/BankB, issuer g·ª≠i 10000 USDX ‚Üí BankA.

K·∫øt qu·∫£ ghi v√†o ~/stellar-dev/usdx-keys.json

N·∫øu mu·ªën chuy·ªÉn ngay:

node scripts/create_usdx_network.js transfer 500


Ki·ªÉm tra balances:

export ISSUER_PUBLIC=$(jq -r .ISSUER_PUBLIC ~/stellar-dev/usdx-keys.json)
export BANKA_PUBLIC=$(jq -r .BANKA_PUBLIC ~/stellar-dev/usdx-keys.json)
export BANKB_PUBLIC=$(jq -r .BANKB_PUBLIC ~/stellar-dev/usdx-keys.json)

curl -s "http://localhost:8000/accounts/${BANKA_PUBLIC}" | jq '.balances'
curl -s "http://localhost:8000/accounts/${BANKB_PUBLIC}" | jq '.balances'


M·∫πo x·ª≠ l√Ω l·ªói: n·∫øu friendbot kh√¥ng reachable, truy·ªÅn ADMIN_SECRET (root secret in logs quickstart) v√†o ENV tr∆∞·ªõc khi ch·∫°y script ƒë·ªÉ script d√πng admin t·∫°o account.

B∆∞·ªõc 3 ‚Äî C·∫•u h√¨nh stellar.toml (ph·ª•c v·ª• b·∫±ng static server)

T·∫°o file static:

mkdir -p ~/stellar-dev/static/.well-known
cat > ~/stellar-dev/static/.well-known/stellar.toml <<'TOML'
NETWORK_PASSPHRASE="Test SDF Network ; September 2015"
DOCUMENTATION="Local demo single-domain (Chapter 5 style)"
FEDERATION_SERVER="http://localhost:3001/federation"
TRANSFER_SERVER="http://localhost:3020/transfer"
AUTH_SERVER="http://localhost:3001/auth"
KYC_SERVER="http://localhost:3010/kyc"
ACCOUNTS=["$ISSUER_PUBLIC"]
TOML


D√πng express ƒë·ªÉ serve:

cd ~/stellar-dev/static
npm init -y
npm install express
node server.js & disown


Test:

curl -sS http://localhost:8080/.well-known/stellar.toml

B∆∞·ªõc 4 ‚Äî Federation (port 3001)

T·∫°o server federation (file ~/stellar-dev/federation/server.js) ‚Äî resolve name*localhost ‚Üí public key (m√£ s·∫µn trong usdx-keys.json).

C√†i & ch·∫°y:

cd ~/stellar-dev/federation
npm init -y
npm install express
node server.js & disown


Test resolve:

curl "http://localhost:3001/federation?q=banka*localhost&type=name"
curl -s "http://localhost:3001/federation?q=bankb*localhost" | jq .

B∆∞·ªõc 5 ‚Äî Compliance / KYC mock (port 3010)

T·∫°o server KYC (in-memory) ‚Äî ~/stellar-dev/compliance/server.js.

C√†i & ch·∫°y:

cd ~/stellar-dev/compliance
npm init -y
npm install express body-parser
node server.js & disown


Test:

curl -s -X POST http://localhost:3010/kyc -H 'content-type:application/json' -d '{"id":"cust1","name":"Nguyen Van A"}' | jq .
curl -s http://localhost:3010/kyc/cust1 | jq .


‚Äî Policy ƒë∆°n gi·∫£n: name ch·ª©a "bad" ‚áí reject.

B∆∞·ªõc 6 ‚Äî Bridge (port 3020) ‚Äî t·∫°o & submit Stellar tx

~/stellar-dev/bridge/server.js c√≥ code sign tx b·∫±ng BANKA_SECRET, optional KYC check, submit l√™n Horizon.

C√†i & ch·∫°y:

cd ~/stellar-dev/bridge
npm init -y
npm install express body-parser stellar-sdk node-fetch@2
node server.js & disown


Test transfer (sau khi KYC approved):

# ensure KYC record exists
curl -s -X POST http://localhost:3010/kyc -H 'content-type:application/json' -d '{"id":"cust1","name":"Nguyen Van A"}' | jq .
# call bridge
TO=$BANKB_PUBLIC
curl -s -X POST http://localhost:3020/transfer -H 'content-type:application/json' \
  -d "{\"to\":\"$TO\",\"amount\":\"5\",\"kycId\":\"cust1\",\"callbackUrl\":\"http://localhost:3030/webhook\"}" | jq .


‚Äî N·∫øu success: JSON { "status":"ok", "tx":"<hash>" }.

X√°c th·ª±c giao d·ªãch tr√™n Horizon:

curl -s "http://localhost:8000/transactions/<TX_HASH>/operations" | jq .

B∆∞·ªõc 7 ‚Äî Callbacks / Webhooks (port 3030)

~/stellar-dev/callbacks/server.js l∆∞u events v√†o memory v√† expose /events.

C√†i & ch·∫°y:

cd ~/stellar-dev/callbacks
npm init -y
npm install express body-parser
node server.js & disown


Test xem event c√≥ t·ªõi ch∆∞a:

curl -s http://localhost:3030/events | jq .

B∆∞·ªõc 8 ‚Äî Portal Backend (port 3040)

~/stellar-dev/portal-backend/server.js ‚Äî mock login, proxy federation, forward KYC & transfer t·ªõi services.

C√†i & ch·∫°y:

cd ~/stellar-dev/portal-backend
npm init -y
npm install express body-parser node-fetch@2
node server.js & disown


Test:

curl -s -X POST http://localhost:3040/api/login -H 'content-type:application/json' -d '{"username":"banka"}' | jq .
curl -s "http://localhost:3040/api/resolve?q=bankb*localhost" | jq .
curl -s "http://localhost:3040/api/balances?account=${BANKA_PUBLIC}" | jq .

B∆∞·ªõc 9 ‚Äî Frontend React (port 3000)

T·∫°o app (n·∫øu ch∆∞a c√≥):

cd ~/stellar-dev
npx create-react-app portal-frontend
cd portal-frontend
# th√™m "proxy": "http://localhost:3040" v√†o package.json (script ƒë√£ cung c·∫•p)
npm install


Thay src/App.js v√† src/App.css b·∫±ng n·ªôi dung trong file (m√¨nh ƒë√£ copy n·ªôi dung trong doc).

Ch·∫°y:

npm start


M·ªü tr√¨nh duy·ªát: http://localhost:3000 ‚Äî login b·∫±ng banka ho·∫∑c bankb (mock).

B∆∞·ªõc 10 ‚Äî Ch·∫°y demo end-to-end

Ki·ªÉm tra m·ªçi d·ªãch v·ª• ƒëang ch·∫°y (c√°c port m·∫∑c ƒë·ªãnh):

8080 static (stellar.toml)
3001 federation
3010 compliance (KYC)
3020 bridge
3030 callbacks
3040 portal-backend
3000 frontend
8000 Horizon


B·∫°n c√≥ th·ªÉ d√πng ss -lntu ho·∫∑c lsof -i -P -n | grep LISTEN ƒë·ªÉ ki·ªÉm tra.

Approve KYC:

curl -s -X POST http://localhost:3010/kyc -H 'content-type:application/json' -d '{"id":"cust1","name":"Nguyen Van A"}' | jq .


T·ª´ UI (frontend) ‚Äî login banka, resolve bankb*localhost, g·ª≠i amount (vd 10) v√† optional kycId:cust1. Ho·∫∑c d√πng API:

BANKB=$(jq -r .BANKB_PUBLIC ~/stellar-dev/usdx-keys.json)
curl -s -X POST http://localhost:3040/api/transfer -H 'content-type:application/json' \
  -d "{\"to\":\"$BANKB\",\"amount\":\"10\",\"kycId\":\"cust1\",\"callbackUrl\":\"http://localhost:3030/webhook\"}" | jq .


Ki·ªÉm tra callbacks/events:

curl -s http://localhost:3030/events | jq .


Ki·ªÉm tra balances tr√™n Horizon:

curl -s "http://localhost:8000/accounts/${BANKA_PUBLIC}" | jq '.balances'
curl -s "http://localhost:8000/accounts/${BANKB_PUBLIC}" | jq '.balances'

Ki·ªÉm tra & debugging ‚Äî checklist nhanh

Friendbot unreachable ‚Üí cung c·∫•p ADMIN_SECRET (t·ª´ docker logs quickstart) cho script create accounts.

N·∫øu server.submitTransaction l·ªói: xem l·ªói chi ti·∫øt (err.response.data) ‚Äî th∆∞·ªùng l·ªói trustline / asset not authorized / insufficient balance.

N·∫øu frontend kh√¥ng resolve bankb*localhost: ki·ªÉm tra federation ch·∫°y (port 3001) v√† proxy backend (3040) c√≥ truy c·∫≠p ƒë√∫ng.

N·∫øu callback kh√¥ng nh·∫≠n event: ki·ªÉm tra callbackUrl g·ª≠i t·ª´ bridge c√≥ ƒë√∫ng http://localhost:3030/webhook v√† callbacks service ƒëang ch·∫°y.

N·∫øu Horizon tr·∫£ transaction contains operations that would change trust etc: ki·ªÉm tra tx ƒë√£ k√Ω ƒë√∫ng key (BankA secret) v√† asset issuer ƒë√∫ng.

C√°c l·ªánh h·ªØu √≠ch t√≥m t·∫Øt

Xem docker logs quickstart (l·∫•y ADMIN_SECRET n·∫øu in ra):

docker logs stellar-quickstart --tail 200


Xem accounts / balances:

curl -s "http://localhost:8000/accounts/<PUBLIC_KEY>" | jq '.balances'


Xem payments cho account:

curl -s "http://localhost:8000/accounts/<PUBLIC_KEY>/payments?order=desc&limit=10" | jq .


Xem events webhook:

curl -s http://localhost:3030/events | jq .

Nh·ªØng c·∫£i ti·∫øn & extension b·∫°n c√≥ th·ªÉ th·ª≠ (sau khi b·∫£n demo ch·∫°y ·ªïn)

L∆∞u KYC v√†o DB (Postgres) thay v√¨ in-memory.

Th√™m Horizon streaming (horizon payments stream) v√†o callbacks ƒë·ªÉ c·∫≠p nh·∫≠t realtime thay v√¨ callback t·ª´ bridge.

Th√™m audit log v√† webhook retry.

M√¥ ph·ªèng AML rule ph·ª©c t·∫°p (v√≠ d·ª•: limit threshold, country checks, sanctions list).

N·∫øu b·∫°n mu·ªën, m√¨nh c√≥ th·ªÉ:

Sinh checklist bash script ƒë·ªÉ kh·ªüi t·∫•t c·∫£ services (systemd / pm2 / docker compose style).

Vi·∫øt file docker-compose.yml ƒë·ªÉ kh·ªüi Horizon + services (y√™u c·∫ßu m√¨nh t·∫°o n·ªôi dung compose).

Ho·∫∑c gi√∫p b·∫°n debug l·ªói c·ª• th·ªÉ ‚Äî d√°n l·ªói log ·ªü ƒë√¢y, m√¨nh ch·ªâ ra nguy√™n nh√¢n v√† c√°ch s·ª≠a.

B·∫°n mu·ªën m√¨nh l√†m ti·∫øp theo ph∆∞∆°ng √°n n√†o?
